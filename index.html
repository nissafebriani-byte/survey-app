<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Element Survey</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0; }
  .container { max-width:700px; margin:40px auto; background:#fff; padding:25px 30px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  h1, h2 { text-align:center; color:#333;}
  label { font-weight:bold; margin-top:15px; display:block;}
  select, button { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc;}
  #elementsGrid { display:flex; flex-wrap:wrap; gap:8px; margin-top:20px;}
  .element-btn { padding:10px 14px; background:#f0f0f0; border:1px solid #ccc; border-radius:8px; cursor:pointer; position:relative; transition: all 0.2s;}
  .element-btn:hover { background:#e0e0ff;}
  .element-btn.selected { background:#007bff; color:white; border-color:#007bff;}
  .tooltip { visibility:hidden; width:220px; background:#333; color:#fff; text-align:center; border-radius:6px; padding:5px; position:absolute; z-index:1; bottom:125%; left:50%; margin-left:-110px; opacity:0; transition:opacity 0.2s; font-size:13px;}
  .element-btn:hover .tooltip { visibility:visible; opacity:1;}
  #warning { color:red; text-align:center; margin-top:10px;}
  #submitBtn { background:#28a745; color:white; font-weight:bold;}
  #submitBtn:hover { background:#1f8838;}
</style>
</head>
<body>
<div class="container">
  <h1>Element Survey</h1>

  <label for="centerSelect">Select Center</label>
  <select id="centerSelect"><option>Loading centers...</option></select>

  <div id="elementsGrid"></div>
  <div id="warning"></div>
  <button id="submitBtn" disabled>Submit Responses</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwkquO_elax63PF9LmyF9cizgqNgW_o0Cj2Bk8wR8i2XgLTUWDBr3PcbGVHOVJp9Bz_eA/exec"; // Replace with your Apps Script Web App URL

let selectedCenter = "";
let selectedElements = {};
let hasSubmitted = {};

async function loadCenters() {
  const select = document.getElementById("centerSelect");
  try {
    const res = await fetch(API_URL + "?action=centers");
    const centers = await res.json();
    select.innerHTML = '<option value="">-- Select Center --</option>';
    centers.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      select.appendChild(opt);
    });
  } catch(err) {
    select.innerHTML = '<option>Error loading centers</option>';
    console.error(err);
  }
}

async function loadElements(center) {
  const grid = document.getElementById("elementsGrid");
  grid.innerHTML = "Loading elements...";
  const res = await fetch(API_URL + "?action=elements&center=" + encodeURIComponent(center));
  const data = await res.json();
  renderElements(data);
}

function renderElements(domains) {
  const grid = document.getElementById("elementsGrid");
  grid.innerHTML = "";
  Object.keys(domains).forEach(domain => {
    const h2 = document.createElement("h2");
    h2.textContent = domain;
    grid.appendChild(h2);

    domains[domain].forEach(el => {
      const btn = document.createElement("button");
      btn.className = "element-btn";
      btn.textContent = el.name;
      const tip = document.createElement("span");
      tip.className = "tooltip";
      tip.textContent = el.desc || "No description";
      btn.appendChild(tip);

      btn.onclick = () => toggleElement(el.name, btn);
      grid.appendChild(btn);
    });
  });
  document.getElementById("submitBtn").disabled = false;
}

function toggleElement(name, btn) {
  const warning = document.getElementById("warning");
  warning.textContent = "";
  if (!selectedElements[selectedCenter]) selectedElements[selectedCenter] = [];

  const list = selectedElements[selectedCenter];
  const idx = list.indexOf(name);
  if (idx >= 0) {
    list.splice(idx, 1);
    btn.classList.remove("selected");
  } else {
    if (list.length >= 20) {
      warning.textContent = "⚠️ You can select up to 20 elements only.";
      return;
    }
    list.push(name);
    btn.classList.add("selected");
  }
}

document.getElementById("centerSelect").addEventListener("change", async (e) => {
  const center = e.target.value;
  const warning = document.getElementById("warning");

  if (selectedCenter && !hasSubmitted[selectedCenter]) {
    e.target.value = selectedCenter;
    warning.textContent = "⚠️ Please submit your current center before moving to another.";
    return;
  }

  selectedCenter = center;
  if (center) {
    warning.textContent = "";
    await loadElements(center);
  } else {
    document.getElementById("elementsGrid").innerHTML = "";
  }
});

document.getElementById("submitBtn").addEventListener("click", async () => {
  if (!selectedCenter) return alert("Select a center first.");
  const responses = selectedElements[selectedCenter] || [];
  if (responses.length === 0) return alert("Please select at least one element.");

  try {
    const payload = { action: "save", center: selectedCenter, elements: responses };
    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    });

    hasSubmitted[selectedCenter] = true;
    alert("Responses submitted successfully for " + selectedCenter);
  } catch(err) {
    alert("Error submitting responses: " + err.message);
  }
});

loadCenters();
</script>
</body>
</html>
