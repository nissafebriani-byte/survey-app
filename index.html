<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Top Topics in Life Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h1 {
      background-color: #f8bcbc;
      color: #222;
      padding: 20px;
      margin: 0;
    }

    p {
      background-color: #f8bcbc;
      display: inline-block;
      padding: 6px 10px;
      border-radius: 4px;
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: left;
    }

    .form-section {
      margin-top: 20px;
    }

    .form-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-section input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    button {
      background-color: #3b5bfd;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #2f49d1;
    }

    .domain {
      margin-top: 25px;
    }

    .domain h3 {
      background-color: #e0e0e0;
      padding: 10px;
      border-radius: 5px;
    }

    .checkbox-group {
      margin-bottom: 10px;
    }

    .hidden {
      display: none;
    }

  </style>
</head>
<body>
  <h1>Top Topics in Life Management</h1>
  <p>Welcome to the Top Topics in Life Management Survey! Your task is to choose which elements you would prioritize buying if you had the money to pay.</p>

  <div class="container">
    <div id="intro">
      <div class="form-section">
        <label for="name">Name</label>
        <input id="name" placeholder="Enter your name" />

        <label for="institution">Institution</label>
        <input id="institution" placeholder="Enter your institution" />

        <label for="position">Position</label>
        <input id="position" placeholder="Enter your position" />

        <label for="email">Email</label>
        <input id="email" placeholder="Enter your email" />

        <label for="center">Choose Center</label>
        <select id="center"></select>
      </div>
      <button id="startBtn">Start</button>
    </div>

    <div id="survey" class="hidden"></div>
    <button id="submitBtn" class="hidden">Submit</button>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_mYYsaKGyDvGpmPiBCesb-OxUu2fz4RvcMzJnPbyK9dbxNq2_Ymd6CpSj0HdQYoVLWg/exec";
    let currentCenter = "";
    let responses = {};

    document.addEventListener("DOMContentLoaded", () => {
      loadCenters();
      document.getElementById("startBtn").addEventListener("click", startSurvey);
      document.getElementById("submitBtn").addEventListener("click", submitSurvey);
    });

    async function loadCenters() {
      const centerSelect = document.getElementById("center");
      centerSelect.innerHTML = "<option>Loading...</option>";
      try {
        const res = await fetch(`${SCRIPT_URL}?action=centers`);
        const centers = await res.json();
        centerSelect.innerHTML = "<option value=''>Select a Center</option>";
        centers.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          centerSelect.appendChild(opt);
        });
      } catch (err) {
        centerSelect.innerHTML = "<option>Error loading centers</option>";
      }
    }

    async function startSurvey() {
      const center = document.getElementById("center").value;
      if (!center) {
        alert("Please choose a center first.");
        return;
      }
      currentCenter = center;
      document.getElementById("intro").classList.add("hidden");
      document.getElementById("survey").classList.remove("hidden");
      document.getElementById("submitBtn").classList.remove("hidden");
      await loadElements(center);
    }

    async function loadElements(center) {
      const surveyDiv = document.getElementById("survey");
      surveyDiv.innerHTML = "<p>Loading...</p>";
      try {
        const res = await fetch(`${SCRIPT_URL}?action=elements&center=${encodeURIComponent(center)}`);
        const data = await res.json();
        surveyDiv.innerHTML = "";
        Object.keys(data).forEach(domain => {
          const domainDiv = document.createElement("div");
          domainDiv.className = "domain";
          const h3 = document.createElement("h3");
          h3.textContent = domain;
          domainDiv.appendChild(h3);
          data[domain].forEach(el => {
            const div = document.createElement("div");
            div.className = "checkbox-group";
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = el.name;
            cb.id = el.name;
            const label = document.createElement("label");
            label.htmlFor = el.name;
            label.textContent = el.name + (el.desc ? " - " + el.desc : "");
            div.appendChild(cb);
            div.appendChild(label);
            domainDiv.appendChild(div);
          });
          surveyDiv.appendChild(domainDiv);
        });
      } catch (err) {
        surveyDiv.innerHTML = "<p>Error loading elements.</p>";
      }
    }

    async function submitSurvey() {
      const checkboxes = document.querySelectorAll("#survey input[type='checkbox']:checked");
      const selected = Array.from(checkboxes).map(cb => cb.value);

      const payload = {
        name: document.getElementById("name").value,
        institution: document.getElementById("institution").value,
        position: document.getElementById("position").value,
        email: document.getElementById("email").value,
        responses: { [currentCenter]: selected }
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        alert("Survey submitted successfully!");
      } catch (err) {
        alert("Error submitting survey: " + err.message);
      }
    }
  </script>
</body>
</html>
