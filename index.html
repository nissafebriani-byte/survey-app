<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Element Survey</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0;}
.container { max-width: 900px; margin: 40px auto; background: #fff; padding: 25px 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
h1 { text-align:center; margin-bottom: 20px;}
label { font-weight:bold; margin-top:15px; display:block; }
input, select, button { width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #ccc; }
#elementsGrid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:8px; margin-top:20px;}
.element-btn { padding:6px 10px; font-size:14px; background:#f0f0f0; border:1px solid #ccc; border-radius:6px; cursor:pointer; position:relative; text-align:center; }
.element-btn:hover { background:#e0e0ff; }
.element-btn.selected { background:#007bff; color:white; border-color:#007bff; }
.tooltip { visibility:hidden; width:220px; background-color:#333; color:#fff; text-align:center; border-radius:6px; padding:5px; position:absolute; z-index:1; bottom:125%; left:50%; margin-left:-110px; opacity:0; transition:opacity 0.2s; font-size:13px; }
.element-btn:hover .tooltip { visibility:visible; opacity:1; }
#warning { color:red; text-align:center; margin-top:10px; }
#submitBtn { background:#28a745; color:white; font-weight:bold; }
#submitBtn:hover { background:#1f8838; }
</style>
</head>
<body>
<div class="container">
<h1>Element Survey</h1>

<label for="name">Name</label>
<input type="text" id="name" placeholder="Your name">

<label for="institution">Institution</label>
<input type="text" id="institution" placeholder="Your institution">

<label for="position">Position</label>
<input type="text" id="position" placeholder="Your position">

<label for="email">Email</label>
<input type="email" id="email" placeholder="Your email">

<label for="centerSelect">Select Center</label>
<select id="centerSelect">
<option value="">Loading centers...</option>
</select>

<div id="elementsGrid"></div>
<div id="warning"></div>
<button id="submitBtn" disabled>Submit Responses</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyaZzolVY_ihmF57UYe9rkoiChqkaCTtOw54t9Gpm9yFP8jD70pI2CA356x1Ratk1nSlg/exec";

let selectedCenter = "";
let selectedElements = {};
let hasSubmitted = {};

async function loadCenters() {
  try {
    const res = await fetch(`${API_URL}?action=centers`);
    const centers = await res.json();
    const select = document.getElementById("centerSelect");
    select.innerHTML = '<option value="">-- Select Center --</option>';
    centers.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      select.appendChild(opt);
    });
  } catch(err) {
    console.error(err);
    document.getElementById("centerSelect").innerHTML = '<option value="">Failed to load centers</option>';
  }
}

async function loadElements(center) {
  const grid = document.getElementById("elementsGrid");
  grid.innerHTML = "Loading elements...";
  try {
    const res = await fetch(`${API_URL}?action=elements&center=${encodeURIComponent(center)}`);
    const data = await res.json();
    renderElements(data);
  } catch(err) {
    grid.innerHTML = "Failed to load elements";
    console.error(err);
  } finally {
    document.getElementById("submitBtn").disabled = false;
  }
}

function renderElements(domains) {
  const grid = document.getElementById("elementsGrid");
  grid.innerHTML = "";
  Object.keys(domains).forEach(domain => {
    const h2 = document.createElement("h2");
    h2.textContent = domain;
    h2.style.gridColumn = "1 / -1";
    grid.appendChild(h2);

    domains[domain].forEach(el => {
      const btn = document.createElement("button");
      btn.className = "element-btn";
      btn.textContent = el.name;

      const tip = document.createElement("span");
      tip.className = "tooltip";
      tip.textContent = el.desc || "No description";
      btn.appendChild(tip);

      btn.onclick = () => toggleElement(el.name, btn);
      grid.appendChild(btn);
    });
  });
}

function toggleElement(name, btn) {
  const warning = document.getElementById("warning");
  warning.textContent = "";
  if (!selectedElements[selectedCenter]) selectedElements[selectedCenter] = [];

  const list = selectedElements[selectedCenter];
  const idx = list.indexOf(name);
  if (idx >= 0) {
    list.splice(idx, 1);
    btn.classList.remove("selected");
  } else {
    if (list.length >= 20) {
      warning.textContent = "⚠️ You can select up to 20 elements only.";
      return;
    }
    list.push(name);
    btn.classList.add("selected");
  }
}

document.getElementById("centerSelect").addEventListener("change", async (e) => {
  const center = e.target.value;
  const warning = document.getElementById("warning");

  if (selectedCenter && !hasSubmitted[selectedCenter]) {
    e.target.value = selectedCenter;
    warning.textContent = "⚠️ Please submit your current center before moving to another.";
    return;
  }

  selectedCenter = center;
  if (center) {
    warning.textContent = "";
    await loadElements(center);
  } else {
    document.getElementById("elementsGrid").innerHTML = "";
  }
});

// ✅ FIXED SUBMIT BUTTON SECTION ONLY
document.getElementById("submitBtn").addEventListener("click", async () => {
  if (!selectedCenter) return alert("Select a center first.");
  const responses = selectedElements[selectedCenter] || [];
  if (responses.length === 0) return alert("Please select at least one element.");

  const payload = {
    name: document.getElementById("name").value,
    institution: document.getElementById("institution").value,
    position: document.getElementById("position").value,
    email: document.getElementById("email").value,
    responses: { [selectedCenter]: responses }
  };

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.textContent = "Submitting...";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let result;
    try { result = JSON.parse(text); } catch { result = { status: text }; }

    if (result.status === "success") {
      hasSubmitted[selectedCenter] = true;
      alert("Responses submitted successfully for " + selectedCenter);
    } else {
      alert("Failed to submit: " + (result.message || text));
    }
  } catch (err) {
    console.error(err);
    alert("Failed to submit responses. Please check your connection or API permissions.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Submit Responses";
  }
});

loadCenters();
</script>
</body>
</html>
