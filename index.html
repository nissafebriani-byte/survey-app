<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Element Survey</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      max-width: 900px;
    }
    .center-section, .form-section {
      margin-bottom: 25px;
    }
    .domain {
      margin-bottom: 20px;
    }
    .elements {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .element-btn {
      padding: 8px 12px;
      border: 1px solid #aaa;
      border-radius: 6px;
      cursor: pointer;
      background-color: #f4f4f4;
      transition: 0.2s;
      position: relative;
    }
    .element-btn.selected {
      background-color: #cce5ff;
      border-color: #004085;
      color: #004085;
    }
    .element-btn:hover::after {
      content: attr(data-desc);
      position: absolute;
      background: #333;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: pre-wrap;
      top: 120%;
      left: 0;
      width: 250px;
      z-index: 5;
      font-size: 13px;
    }
    button {
      padding: 10px 15px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Element Survey</h2>

  <div class="form-section">
    <label>Name: <input type="text" id="name"></label><br><br>
    <label>Email: <input type="email" id="email"></label><br><br>
    <label>Institution: <input type="text" id="institution"></label><br><br>
    <label>Position: <input type="text" id="position"></label><br><br>
  </div>

  <div class="center-section">
    <label for="centerSelect">Choose Center:</label>
    <select id="centerSelect">
      <option value="">-- Select Center --</option>
    </select>
  </div>

  <div id="elementsContainer"></div>

  <div>
    <button id="submitBtn">Submit</button>
  </div>

  <p id="status"></p>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxO_ofoU8MY0tOranDqgMzVGLdGzw_l-wWugTpydaNVhLzrjebvBH9saIbXzE8qOepvww/exec";
    const MAX_SELECTION = 20;

    let currentCenter = "";
    let responses = {};
    let elementsByDomain = {};

    // Load centers
    fetch(`${SCRIPT_URL}?action=centers`)
      .then(r => r.json())
      .then(centers => {
        const select = document.getElementById("centerSelect");
        centers.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      });

    document.getElementById("centerSelect").addEventListener("change", async e => {
      const newCenter = e.target.value;
      const status = document.getElementById("status");

      if (currentCenter && !responses[currentCenter]) {
        alert("Please submit your selection for the current center before moving to another.");
        e.target.value = currentCenter;
        return;
      }

      currentCenter = newCenter;
      document.getElementById("elementsContainer").innerHTML = "";
      if (!newCenter) return;

      const res = await fetch(`${SCRIPT_URL}?action=elements&center=${encodeURIComponent(newCenter)}`);
      elementsByDomain = await res.json();
      renderElements();
      status.textContent = "";
    });

    function renderElements() {
      const container = document.getElementById("elementsContainer");
      container.innerHTML = "";

      for (const domain in elementsByDomain) {
        const div = document.createElement("div");
        div.className = "domain";

        const h3 = document.createElement("h3");
        h3.textContent = domain;
        div.appendChild(h3);

        const elemsDiv = document.createElement("div");
        elemsDiv.className = "elements";

        elementsByDomain[domain].forEach(el => {
          const btn = document.createElement("div");
          btn.className = "element-btn";
          btn.textContent = el.name;
          btn.setAttribute("data-desc", el.desc);

          btn.addEventListener("click", () => {
            toggleElement(el.name, btn);
          });

          elemsDiv.appendChild(btn);
        });

        div.appendChild(elemsDiv);
        container.appendChild(div);
      }
    }

    function toggleElement(name, btn) {
      const selected = responses[currentCenter] || [];
      const index = selected.indexOf(name);

      if (index === -1) {
        if (selected.length >= MAX_SELECTION) {
          alert("You can only select up to 20 elements per center.");
          return;
        }
        selected.push(name);
        btn.classList.add("selected");
      } else {
        selected.splice(index, 1);
        btn.classList.remove("selected");
      }

      responses[currentCenter] = selected;
    }

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const institution = document.getElementById("institution").value.trim();
      const position = document.getElementById("position").value.trim();
      const status = document.getElementById("status");

      if (!name || !email || !institution || !position) {
        alert("Please fill out all personal information fields.");
        return;
      }

      if (!currentCenter || !responses[currentCenter] || responses[currentCenter].length === 0) {
        alert("Please select at least one element for the current center.");
        return;
      }

      const payload = {
        name,
        email,
        institution,
        position,
        responses
      };

      status.textContent = "Submitting...";

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          mode: "no-cors"
        });

        responses[currentCenter] = responses[currentCenter]; // lock current center
        alert("Submission successful for " + currentCenter);
        status.textContent = "Submitted successfully!";
      } catch (err) {
        alert("Failed to submit. Please try again.");
        status.textContent = "Submission failed.";
      }
    });
  </script>
</body>
</html>
