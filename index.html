<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Element Survey</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f4f9;
    }
    h1, h2 {
      text-align: center;
    }
    .hidden {
      display: none;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      background-color: #e0e0e0;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #d5d5d5;
    }
    button.selected {
      background-color: #4CAF50;
      color: white;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%; 
      left: 50%;
      margin-left: -100px;
      width: 200px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .center-button {
      display: block;
      width: 100%;
      background-color: #2196F3;
      color: white;
      margin: 10px 0;
    }
    .submit-btn {
      background-color: #4CAF50;
      color: white;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Element Survey</h1>

  <div id="user-form">
    <h2>Participant Information</h2>
    <label>Name:</label><br>
    <input type="text" id="name"><br><br>
    <label>Email:</label><br>
    <input type="email" id="email"><br><br>
    <label>Institution:</label><br>
    <input type="text" id="institution"><br><br>
    <label>Position:</label><br>
    <input type="text" id="position"><br><br>
    <button id="start-btn">Start Survey</button>
  </div>

  <div id="survey" class="hidden">
    <h2>Select a Center</h2>
    <div id="centers"></div>

    <div id="elements-section" class="hidden">
      <h2 id="center-title"></h2>
      <div id="elements"></div>
      <button id="submit-btn" class="submit-btn">Submit This Center</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxO_ofoU8MY0tOranDqgMzVGLdGzw_l-wWugTpydaNVhLzrjebvBH9saIbXzE8qOepvww/exec";
    const responses = {};
    let currentCenter = null;

    document.getElementById("start-btn").addEventListener("click", () => {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const institution = document.getElementById("institution").value.trim();
      const position = document.getElementById("position").value.trim();
      if (!name || !email || !institution || !position) {
        alert("Please fill out all fields.");
        return;
      }
      document.getElementById("user-form").classList.add("hidden");
      document.getElementById("survey").classList.remove("hidden");
      loadCenters();
    });

    async function loadCenters() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=centers`);
        const centers = await res.json();
        const div = document.getElementById("centers");
        div.innerHTML = "";
        centers.forEach(c => {
          const btn = document.createElement("button");
          btn.className = "center-button";
          btn.textContent = c;
          btn.onclick = () => loadElements(c);
          div.appendChild(btn);
        });
      } catch (err) {
        alert("Failed to load centers. Please check your connection or Apps Script URL.");
      }
    }

    async function loadElements(center) {
      if (currentCenter && !responses[currentCenter]) {
        alert("Please submit your selections for the current center before moving to another one.");
        return;
      }

      currentCenter = center;
      try {
        const res = await fetch(`${SCRIPT_URL}?action=elements&center=${encodeURIComponent(center)}`);
        const data = await res.json();

        document.getElementById("center-title").textContent = center;
        document.getElementById("elements-section").classList.remove("hidden");

        const container = document.getElementById("elements");
        container.innerHTML = "";

        Object.entries(data).forEach(([domain, items]) => {
          const h3 = document.createElement("h3");
          h3.textContent = domain;
          container.appendChild(h3);

          items.forEach(el => {
            const btn = document.createElement("button");
            btn.textContent = el.name;
            btn.classList.add("tooltip");

            const tip = document.createElement("span");
            tip.className = "tooltiptext";
            tip.textContent = el.desc;
            btn.appendChild(tip);

            btn.onclick = () => {
              const selected = container.querySelectorAll("button.selected").length;
              if (btn.classList.contains("selected")) {
                btn.classList.remove("selected");
              } else if (selected < 20) {
                btn.classList.add("selected");
              } else {
                alert("You can select up to 20 elements per center.");
              }
            };

            container.appendChild(btn);
          });
        });
      } catch (err) {
        alert("Failed to load elements. Please try again.");
      }
    }

    document.getElementById("submit-btn").addEventListener("click", async () => {
      if (!currentCenter) return;

      const selected = Array.from(document.querySelectorAll("#elements button.selected")).map(b => b.textContent);
      if (selected.length === 0) {
        alert("Please select at least one element.");
        return;
      }

      responses[currentCenter] = selected;
      alert(`Selections for ${currentCenter} saved! You can now move to another center.`);

      const payload = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
        institution: document.getElementById("institution").value,
        position: document.getElementById("position").value,
        responses
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        if (text.includes("OK")) {
          alert("Responses submitted successfully!");
        } else {
          alert("Submission error: " + text);
        }
      } catch (err) {
        alert("Failed to submit. Please try again later.");
      }
    });
  </script>
</body>
</html>
